# TPF2-Timetables 项目上下文

## 项目概述

TPF2-Timetables 是一个为 Transport Fever 2 游戏开发的模组，它在游戏中添加了时刻表系统。该模组允许玩家指定载具应在何时停靠车站以及何时出发，从而实现对火车、公交车和其他载具的现实调度。

### 主要功能

1. **多种约束类型**：
   - **到发时刻**：指定确切的到达/出发时间段
   - **间隔控制**：强制执行载具出发之间的最小间隔
   - **自动间隔控制**：根据线路频率自动安排载具间隔

2. **增强功能**：
   - 支持同一车站的多个载具
   - 在保存/加载周期间保持载具状态
   - 最小/最大等待时间支持
   - 更新的界面颜色以兼容春季更新

3. **技术改进**：
   - 更好的性能优化
   - 提高的可靠性和可维护性
   - 全面的测试套件

### 项目状态

这是由 IncredibleHannes 开发的原始 TPF2-Timetables 模组的一个分支，由 Gregory365 维护并有多位开发者贡献。目标是整合社区改进，重构代码库以提高质量，并向 Steam 创意工坊发布更新版本。

## 项目结构

```
TPF2-Timetables/
├── .github/workflows/     # GitHub Actions CI 配置
├── res/
│   ├── config/
│   │   ├── game_script/   # 主图形用户界面实现
│   │   └── style_sheet/   # 用户界面样式
│   └── scripts/
│       └── celmi/
│           └── timetables/ # 核心模组逻辑
├── tests/                 # 单元测试
├── mod.lua               # 模组元数据
├── strings.lua           # 本地化字符串
├── README.md             # 用户文档
├── documentation.md      # 开发者文档
└── description.txt       # Steam 创意工坊描述
```

### 核心组件

1. **主逻辑** (`res/scripts/celmi/timetables/`)：
   - `timetable.lua`：核心时刻表逻辑和约束处理
   - `timetable_helper.lua`：游戏 API 交互和实用函数
   - `guard.lua`：简单的参数验证工具

2. **用户界面** (`res/config/game_script/`)：
   - `timetable_gui.lua`：完整的时刻表配置图形用户界面实现

3. **本地化** (`strings.lua`)：
   - 多语言支持（英语、德语、俄语、意大利语、法语、中文变体）

4. **测试** (`tests/`)：
   - 核心功能的单元测试
   - 用于隔离测试的模拟对象

## 开发环境

### 先决条件

- Transport Fever 2 游戏安装
- Lua 5.3+（用于本地运行测试）
- Luacheck（用于代码检查）

### 项目设置

1. 克隆仓库
2. 将模组文件夹放置在您的 TF2 模组目录中
3. 在游戏中启用模组

### 代码标准

- 最大行长度：150个字符（在 `.luacheckrc` 中配置）
- 允许使用标准 Lua 全局变量及游戏特定的 API
- 函数应包含带有参数类型和描述的文档注释

## 构建与测试

### 本地开发

该模组无需编译即可直接在 Transport Fever 2 中运行。只需将文件放入模组目录即可。

### 测试

本地运行单元测试：
```bash
lua tests/main_tests.lua
```

### 持续集成

GitHub Actions 工作流包括：
1. Luacheck 代码检查
2. Lua 单元测试执行

## 架构概览

### 数据流

1. **数据存储**：时刻表约束按线路/车站组合存储
2. **游戏集成**：当载具在车站时挂钩到载具状态更新
3. **决策逻辑**：根据时刻表约束确定载具是否应该等待
4. **用户界面层**：提供配置时刻表的接口

### 关键概念

- **约束**：定义载具行为的每站规则
- **时段**：到达/出发调度的时间窗口
- **等待载具**：跟踪等待出发许可的载具的系统
- **状态持久化**：在保存/加载周期间维持调度信息

### API 交互

模组通过以下方式与游戏交互：
- 使用 `api.engine.getComponent()` 访问游戏实体
- 使用 `api.cmd.sendCommand()` 控制载具行为
- 各种游戏系统如 transportVehicleSystem 和 lineSystem

## 贡献指南

### 工作流程

1. 分叉仓库
2. 创建功能分支
3. 提交拉取请求以供审查
4. 参与代码审查

### 测试要求

新功能应包括：
- 覆盖核心逻辑的单元测试
- 与现有测试套件的集成
- 适当时进行游戏内手动测试

### 文档

- 为面向用户的更改更新 README.md
- 为面向开发者的更改更新 documentation.md
- 为复杂逻辑维护内联代码注释

## 常见开发任务

### 添加新的约束类型

1. 扩展 GUI 中的约束类型枚举
2. 在 `timetable.lua` 中添加处理逻辑
3. 更新 `timetable_gui.lua` 中的 UI 组件
4. 添加本地化字符串
5. 编写单元测试

### 调试载具行为

1. 检查 `timetable.lua` 中的载具状态转换
2. 验证约束评估逻辑
3. 检查时间计算
4. 验证 `timetable_helper.lua` 中的游戏 API 交互

### 性能优化

1. 对决策逻辑中的热点路径进行性能分析
2. 优化频繁访问数据的数据结构
3. 最小化游戏 API 调用
4. 在适当时缓存计算值